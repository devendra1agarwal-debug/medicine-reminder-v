<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart Medicine Reminder v3</title>
<style>
  body{
    margin:0;font-family:"Segoe UI",sans-serif;
    background:radial-gradient(circle at top,#0b1220,#000);
    color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;
  }
  .wrapper{
    background:rgba(255,255,255,0.06);backdrop-filter:blur(12px);
    border-radius:20px;padding:20px;width:440px;max-width:95vw;
    box-shadow:0 15px 40px rgba(0,0,0,0.7);
  }
  h1{color:#22d3ee;text-align:center;}
  label{display:block;margin-top:10px;font-size:0.9rem;color:#9ca3af;}
  input[type="text"],input[type="time"],select{
    width:100%;padding:8px 10px;margin-top:5px;border-radius:8px;
    background:rgba(255,255,255,0.08);border:none;color:#fff;
  }
  button{
    background:#22d3ee;color:#001;border:none;font-weight:600;
    padding:10px 12px;border-radius:8px;cursor:pointer;
  }
  button:hover{background:#38e0ff;}
  .btn-small{padding:6px 8px;font-size:0.85rem;}
  .permbar{
    position:fixed;top:0;left:0;right:0;background:#2563eb;color:white;
    text-align:center;padding:10px;font-size:0.95rem;display:none;z-index:999;
  }
  .permbar button{
    background:white;color:#2563eb;margin-left:8px;padding:5px 10px;border-radius:8px;
  }
  .cat-group{
    background:rgba(255,255,255,0.05);border-radius:12px;padding:10px;margin-top:10px;
  }
  .cat-title{color:#22d3ee;font-weight:700;margin-bottom:6px;}
  .time-group{
    background:rgba(255,255,255,0.05);border-radius:10px;padding:8px;margin-top:6px;
  }
  .time-title{color:#9ae6ff;font-weight:600;margin-bottom:4px;}
  .med-row{display:flex;flex-wrap:wrap;gap:6px;}
  .med{
    background:rgba(255,255,255,0.08);border-radius:8px;padding:8px 10px;
    flex:1 1 45%;display:flex;justify-content:space-between;align-items:center;
  }
  .med.taken{text-decoration:line-through;color:#7bc9a7;}
</style>
</head>
<body>
<div class="permbar" id="permbar">
  🔔 Allow notifications and sound for reminders
  <button id="allowBtn">Allow</button>
</div>

<div class="wrapper">
  <h1>💊 Medicine Reminder</h1>

  <label>Category</label>
  <select id="catSelect"></select>
  <button id="addCatBtn" style="margin-top:6px;width:100%;background:#475569;color:#fff;">Add New Category</button>

  <label>Medicine Name</label>
  <input id="name" type="text" placeholder="e.g. Paracetamol">

  <label>Dose (optional)</label>
  <input id="dose" type="text" placeholder="e.g. 500mg">

  <label>Time</label>
  <input id="time" type="time">

  <button id="addBtn" style="width:100%;margin-top:10px;">Add / Update Medicine</button>

  <div class="list" id="list" style="margin-top:15px;"></div>
</div>

<script>
const permbar=document.getElementById("permbar");
const allowBtn=document.getElementById("allowBtn");
const addBtn=document.getElementById("addBtn");
const addCatBtn=document.getElementById("addCatBtn");
const nameIn=document.getElementById("name");
const doseIn=document.getElementById("dose");
const timeIn=document.getElementById("time");
const catSel=document.getElementById("catSelect");
const listDiv=document.getElementById("list");

let data=JSON.parse(localStorage.getItem("med_v4")||"{}");
if(!data.cats)data.cats={"General":[]};
let editId=null;let activeAlarm=null;const BEEP_TIME=10000;

function save(){localStorage.setItem("med_v4",JSON.stringify(data));}

function refreshCats(){
  catSel.innerHTML="";
  for(const c in data.cats){
    const o=document.createElement("option");
    o.value=c;o.textContent=c;catSel.appendChild(o);
  }
}
refreshCats();

function showPerm(){permbar.style.display="block";}
function hidePerm(){permbar.style.display="none";}
function askPermission(){
  try{Notification.requestPermission().then(p=>console.log(p));}catch(e){}
  playBeep(0.2);
  hidePerm();
}
allowBtn.onclick=askPermission;

function playBeep(vol=1){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.type="sine";osc.frequency.setValueAtTime(800,ctx.currentTime);
    gain.gain.value=vol;osc.connect(gain);gain.connect(ctx.destination);
    osc.start();setTimeout(()=>{osc.stop();ctx.close();},200);
  }catch(e){}
}
function startAlarm(list){
  if(activeAlarm)return;activeAlarm=true;
  const beepInt=setInterval(()=>playBeep(),1000);
  setTimeout(()=>{clearInterval(beepInt);activeAlarm=false;},BEEP_TIME);
  if(Notification.permission==="granted"){
    new Notification("Medicine Time",{body:list.map(m=>m.name).join(", ")});
  }
}

function addCategory(){
  const name=prompt("Enter new category name:");
  if(!name)return;
  if(!data.cats[name])data.cats[name]=[];
  save();refreshCats();
  catSel.value=name;
}
addCatBtn.onclick=addCategory;

function addMedicine(){
  const n=nameIn.value.trim(),d=doseIn.value.trim(),t=timeIn.value,c=catSel.value;
  if(!n||!t){alert("Enter name and time");return;}
  const meds=data.cats[c];
  if(editId){
    const m=findById(editId);
    Object.assign(m,{name:n,dose:d,time:t,taken:false});
    editId=null;
  } else {
    meds.push({id:Date.now(),name:n,dose:d,time:t,taken:false});
  }
  save();render();nameIn.value="";doseIn.value="";timeIn.value="";
}
addBtn.onclick=addMedicine;

function findById(id){
  for(const c in data.cats){
    for(const m of data.cats[c])if(m.id===id)return m;
  }
}

function render(){
  listDiv.innerHTML="";
  for(const c in data.cats){
    const meds=data.cats[c];
    if(meds.length===0)continue;
    const catDiv=document.createElement("div");
    catDiv.className="cat-group";
    const catTitle=document.createElement("div");
    catTitle.className="cat-title";
    catTitle.textContent=c+" ";
    const delCat=document.createElement("button");
    delCat.textContent="🗑";delCat.className="btn-small";
    delCat.onclick=()=>{if(confirm("Remove category "+c+"?")){delete data.cats[c];save();refreshCats();render();}};
    catTitle.appendChild(delCat);
    catDiv.appendChild(catTitle);
    // group by time
    const groups={};
    meds.forEach(m=>{
      if(!groups[m.time])groups[m.time]=[];
      groups[m.time].push(m);
    });
    const times=Object.keys(groups).sort();
    times.forEach(t=>{
      const g=document.createElement("div");g.className="time-group";
      const tTitle=document.createElement("div");tTitle.className="time-title";tTitle.textContent=t;
      const row=document.createElement("div");row.className="med-row";
      groups[t].forEach(m=>{
        const div=document.createElement("div");div.className="med"+(m.taken?" taken":"");
        div.innerHTML=`<div>${m.name}${m.dose?" ("+m.dose+")":""}</div>`;
        const btn=document.createElement("button");btn.className="btn-small";btn.textContent=m.taken?"Undo":"Taken";
        btn.onclick=()=>{m.taken=!m.taken;save();render();};
        const edit=document.createElement("button");edit.textContent="✏";edit.className="btn-small";
        edit.onclick=()=>{nameIn.value=m.name;doseIn.value=m.dose;timeIn.value=m.time;catSel.value=c;editId=m.id;};
        const del=document.createElement("button");del.textContent="❌";del.className="btn-small";
        del.onclick=()=>{if(confirm("Delete "+m.name+"?")){data.cats[c]=data.cats[c].filter(x=>x.id!==m.id);save();render();}};
        div.append(btn,edit,del);
        row.appendChild(div);
      });
      g.append(tTitle,row);
      catDiv.appendChild(g);
    });
    listDiv.appendChild(catDiv);
  }
}

function checkDue(){
  const now=new Date();const hm=now.toTimeString().slice(0,5);
  const due=[];
  for(const c in data.cats){
    data.cats[c].forEach(m=>{if(m.time===hm&&!m.taken)due.push(m);});
  }
  if(due.length>0)startAlarm(due);
}

render();
refreshCats();
setInterval(checkDue,30*1000);
if(Notification.permission!=="granted")showPerm();
</script>
</body>
</html>
